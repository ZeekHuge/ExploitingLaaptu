#define targetFile "C:/Users/Zubeen/Desktop/ExploitingLaapto/others/output.html"
#include <stdlib.h>
#include <stdio.h>
#include "..\include\zeek_find_helper.h"

#include "..\include\curl\curl.h"
#define freeze  \
	{ \
	fprintf(stderr,"\n............Freezed............\n");  \
	getch(); \
	exit(0);\
	}
	
#define CAPTCHAcode 1
#define GETidentity 2




/***********************************************************************************************/
//********* Variable declarations *************//



CURL *curl;
CURLcode res;

struct curl_slist *headers=NULL, *headers1=NULL;


char search_for[100][1000];
char get_in[100][1000];


void perform_data_transfer()
{
      res = curl_easy_perform(curl);

      if(res != CURLE_OK)
	fprintf(stderr, "curl_easy_perform() failed: %s\n",curl_easy_strerror(res));
}


void prepare_headers_1(void)
{
 headers1 = curl_slist_append(headers, "User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"); 
 headers1 = curl_slist_append(headers, "Referer: http://u.laaptu.com/login22.action");
 headers1 = curl_slist_append(headers, "Accept: image/png,image/*;q=0.8,*/*;q=0.5");
 headers1 = curl_slist_append(headers, "Accept-Language: en-US,en;q=0.5");
 headers1 = curl_slist_append(headers, "Connection: keep-alive");
}

void prepare_headers_2(void)
{
 headers = curl_slist_append(headers, "User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"); 
 headers = curl_slist_append(headers, "Referer: http://u.laaptu.com/login22.action");
 headers = curl_slist_append(headers, "Accept: text/html");
 headers = curl_slist_append(headers, "Accept-Language: en-US,en;q=0.5");
 headers = curl_slist_append(headers, "Connection: keep-alive");
}


void request_1(void)
{
 //prepare_headers_1() ;
 //headers=NULL;
  
 //curl_easy_setopt(curl, CURLOPT_URL, "http://u.laaptu.com/Validaccount.action?id=3A35022EDD2CCE3C67FD4F4D23FE7F33.LT02");
 curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);
 curl_easy_setopt(curl, CURLOPT_COOKIEFILE, "C:/Users/Zubeen/Desktop/ExploitingLaapto/cookieFile.txt"); 
 curl_easy_setopt(curl, CURLOPT_COOKIEJAR, "C:/Users/Zubeen/Desktop/ExploitingLaapto/cookieFile.txt"); 
 curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
 curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L);
 curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0L);
 curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers) ; 
 curl_easy_setopt(curl, CURLOPT_HTTPGET, 1L) ;
// curl_easy_setopt(curl, CURLOPT_HTTPPOST, 0L) ;
// curl_easy_setopt(curl, CURLOPT_PUT, 0L);
// curl_easy_setopt(curl, CURLOPT_POST, 1L);
// curl_easy_setopt(curl, CURLOPT_POSTFIELDS, "username=me.zubeen3%40gmail%2Ccom&password=3vartika");

perform_data_transfer();
}




void request_2(void)
{
 curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);
 curl_easy_setopt(curl, CURLOPT_COOKIEFILE, "C:/Users/Zubeen/Desktop/ExploitingLaapto/cookieFile.txt"); 
 curl_easy_setopt(curl, CURLOPT_COOKIEJAR, "C:/Users/Zubeen/Desktop/ExploitingLaapto/cookieFile.txt"); 
 curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
 curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L);
 curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0L);
 curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers) ; 
// curl_easy_setopt(curl, CURLOPT_HTTPGET, 1L) ;
// curl_easy_setopt(curl, CURLOPT_HTTPPOST, 0L) ;
// curl_easy_setopt(curl, CURLOPT_PUT, 0L);
 curl_easy_setopt(curl, CURLOPT_POST, 1L);
 //curl_easy_setopt(curl, CURLOPT_POSTFIELDS, "username=me.zubeen3%40gmail.com&password=3vartika");

 perform_data_transfer();
}











void getData(int choose, char geteen[100])
{
	char arr[1][100];
	char getIn[1][100];
	int num = 1, t;
	
	output_file= fopen(targetFile, "r");
	if(output_file==NULL)
	{	printf("couldnt open file");
		exit(0);
	}
	rewind(output_file);
	
	
	
	if (choose== CAPTCHAcode)
	{
		t = 1;
		wordChange1 ='\'' ;
		wordChange2 ='?';
		strcpy(&arr[0][0],"loadcap.jpg");
	}
	else if (choose== GETidentity)
	{
		t = 3;
		wordChange1 ='\"' ;
		wordChange2 ='?';
		strcpy(&arr[0][0],"quizcontest.action");
	}
	
	while(t--)
	{
		find (arr, 1, &num, getIn);
	}
	strcpy(&geteen[0],&getIn[0][0]);
}








	
int main(void)
{
	char add[100] = {"http://u.laaptu.com/loadcap.jpg?"};
	char funquizAdd[100]={"http://u.laaptu.com/quiz.action?"};
	char str[100];
	char secure_code[50]= {"secure_code="} ;  
	//output_file=fopen(targetFile,"r");
	//here;
	
	
	
	curl_global_init(CURL_GLOBAL_ALL);
 
 curl = curl_easy_init();
	
	if(curl) 
	{
		//...........................................................................................................................................................................................................................................Starting the program
		
		prepare_headers_2();
		freopen("C:/Users/Zubeen/Desktop/ExploitingLaapto/others/output.html","w",stdout );
		
		
		//...........................................................................................................................................................................................................................................going thru fiddler

		fprintf(stderr,"\n Open proxy on fiddler ? = ") ;
		{
			int kllkl;
			//scanf("%d",&kllkl);
			if(kllkl)
			{
				///curl_easy_setopt(curl, CURLOPT_PROXY, "127.0.0.1:8888");
				//curl_easy_setopt(curl, CURLOPT_HTTPPROXYTUNNEL, 0L);
			}
		}
		
		//...............................................................................................................................................................................................................................................giong to login

		curl_easy_setopt(curl, CURLOPT_POSTFIELDS, "username=me.zubeen3%40gmail.com&password=3vartika");
		curl_easy_setopt(curl, CURLOPT_URL, "http://u.laaptu.com/login.action");
		request_2();
		fclose(stdout);
		//system("C:/Users/Zubeen/Desktop/ExploitingLaapto/others/output.html");

		
		//..................................................................................................................................................................................................................................getting the captcha image

		fprintf(stderr, "\n getting loadCaptcha number\n");
		getData(CAPTCHAcode, str);
		strcat(add,str);
		fprintf(stderr,"\ncaptcha address = %s\n",add);
		freopen("C:/Users/Zubeen/Desktop/ExploitingLaapto/others/captcha.png","wb",stdout );
		curl_easy_setopt(curl, CURLOPT_URL, add);
		request_1();
		fclose(stdout);
		
		
		//..................................................................................................................................................................................................................................getting text from captcha

		system("C:/Users/Zubeen/Desktop/ExploitingLaapto/others/captcha.png");
		fprintf(stderr,"\n -----Enter captcha code\n") ;
		scanf("%s",str);
		strcat(secure_code, str) ;
		
		
		//..................................................................................................................................................................................................................................going to inside page and answering the captcha

		freopen("C:/Users/Zubeen/Desktop/ExploitingLaapto/others/output.html","w",stdout );
		curl_easy_setopt(curl, CURLOPT_POSTFIELDS, secure_code);
		curl_easy_setopt(curl, CURLOPT_URL, "http://u.laaptu.com/captvalidate.action");
		request_2();
		
		
		
		//..................................................................................................................................................................................................................................going to the fun quiz

		
		fclose(output_file);
		getData(GETidentity, str);
		strcat(funquizAdd,str);
		freopen(targetFile,"w",stdout);
		rewind(stdout);
		curl_easy_setopt(curl, CURLOPT_POSTFIELDS, "Content-Type: application/x-www-form-urlencodedContent-Length: 0");
		curl_easy_setopt(curl, CURLOPT_URL, funquizAdd);
		
		request_2();
		fclose(stdout);
		system("C:/Users/Zubeen/Desktop/ExploitingLaapto/others/output.html");
		
		//
		
		curl_easy_cleanup(curl);
	}
 
  curl_global_cleanup();
 
  return 0;
}


